# 8 - Using External Libraries

While we can make many efforts to write our own optimised data storage and solver routines, a number of libraries exist which will do this far more optimally. In many cases, people will have spent huge amounts of time to write libraries that can perform an action as efficiently as possible, so it is sensible for us to expect their routines to provide a performance increase when compared to ours.

For some smaller routines, you will often be able to find optimal examples shared online, but for larger problems you will often need to incorporate a whole library. In our code, we have facilitated the use of the 'Portable, Extensible Toolkit for Scientific Computation' (PETSc). Installing and using this library is explained in the respective [Installation](#installing-petsc) and [Compilation](#compiling-with-petsc) sections.

When using an external library, we will generally have to write a 'wrapper' in our code, which provides an interface between our own routines and the routines of the library. An example of this is shown in the code snippets below for the `PETSc_Init` module, which initialises the PETSc library. We first create our module and use the `#include` statements to tell the code to use our main path specified in our makefile and then look for this specific file `petscsys.h`. We then tell it to `use petscsys`, allowing us to perform actions which require this file, such as initialising PETSc.

```fortran
module PETSc_Init_Mod
!!Initialize the PETSc Database
#include <petsc/finclude/petscsys.h>
use petscsys
```

We then write our subroutine which does the actual initialisation, `PETSc_Init`. We check if the routine has been called already and if not we call `PETScInitialize`, a routine of the PETSc library. This sets up PETSc such that we can now define our relevant vectors or matrices and then solve the system of equations.

```fortran
Subroutine PETSc_Init
  PetscErrorCode ierr
  logical :: Called = .false.
  if (.not. Called) then
    Call PetscInitialize(PETSC_NULL_CHARACTER,ierr)
    Called = .true.
    if (ierr /= 0) error stop "Failed to Initialize PETSc"
  end if
end subroutine PETSc_Init
```

## Installing PETSc

The Portable, Extensible Toolkit for Scientific Computation (PETSc) is an optional external library which can be utilised in this problem to solve the system of equations generated by the code. This section will give an explanation of how to download and compile PETSc. Note that the configuring and testing of PETSc may take some time. Installation instructions can also be found at <https://petsc.org/release/install/>

- Download a copy of PETSc from: <https://petsc.org/release/download/>

- Place the downloaded PETSc folder into the directory of your choice and navigate inside it through a terminal. Configure the code by running:

```bash
./configure --download-mpich --download-fblaslapack=1 --prefix=recode
```

- Check that the installation was successful by running:

```bash
make all check
```

## Compiling with PETSc

With PETSc installed on your system, the last stage is to set up the environment variables that the code will use to find your PETSc directory. The text below shows how this can be done on a Linux OS, by entering the following commands into your `.bashrc` file:

```bash
export PETSC_DIR="/home/jack/petsc-3.16.0"
export PETSC_ARCH="recode"
```

Once you have installed PETSc (see [installation instructions](#installing-petsc)) and set up the required environment variables, the code can also be compiled to use it instead of the custom storage and solvers. To do so, navigate to the `src` directory within the code and enter the commands:

```bash
make clean
make petsc
```

This will execute the makefile contained within the same directory with the PETSc options, converting the Fortran code to an optimised form that utilises the PETSc library. This then generates an executable named `diffusion_petsc`. Once this has been done, the code can be executed from the parent directory using the command:

```bash
./diffusion_petsc
```
